\section{Formulation 1 (A. Herdt)}\label{sec.form01}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Description}
\begin{itemize}
    \item The constraints on feet placement are simplified (replaced by rectangles)
    \item Dropped the term, which keeps the mean CoM speed close to the reference. The preview window,
    which is currently used, is shorter than required anyway. Also, it seems that this term is dropped
    in mpc-walkgen as well.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Model of the system}
\begin{align*}
\cstate_{k+1} =& \M{A}_k \cstate_k + \M{B}_k \cjerk_k\\
z_{k+1} =& \M{D}_{k+1} \cstate_{k+1}
\end{align*}

\begin{equation*}
\M{A}_k = 
\begin{bmatrix}
    1       & T_k   & T_k^2/2   & 0 & 0 & 0\\
    0       & 1     & T_k       & 0 & 0 & 0\\
    0       & 0     & 1         & 0 & 0 & 0\\
    0 & 0 & 0                   & 1       & T_k   & T_k^2/2   \\
    0 & 0 & 0                   & 0       & 1     & T_k       \\
    0 & 0 & 0                   & 0       & 0     & 1         \\
\end{bmatrix}
\quad
\M{B}_k =
\begin{bmatrix}
    T_k^3/6 & 0\\
    T_k^2/2 & 0\\
    T       & 0\\
    0       & T_k^3/6 \\
    0       & T_k^2/2 \\
    0       & T       \\
\end{bmatrix}
\end{equation*}

\begin{equation*}
\M{D}_{k} = 
\begin{bmatrix}
    1       & 0     & -h_k      & 0 & 0 & 0\\
    0 & 0 & 0                   & 1       & 0     & -h_k  \\
\end{bmatrix}
\quad
h_k = \frac{c^z_k}{g}
\end{equation*}

\begin{equation*}
\M{I}_{p} = 
\begin{bmatrix} 
    1 & 0 & 0 & 0 & 0 & 0 \\
    0 & 0 & 0 & 1 & 0 & 0 
\end{bmatrix}
\quad
\M{I}_{v} = 
\begin{bmatrix} 
    0 & 1 & 0 & 0 & 0 & 0 \\
    0 & 0 & 0 & 0 & 1 & 0 
\end{bmatrix}
\end{equation*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Parameters}
\begin{align*}
T_k = T:&
\quad
\M{A}_k = \M{A},
\quad
\M{B}_k = \M{B}\\
c^z_k = c^z:& 
\quad
h_k = h = \frac{c^z}{g},
\quad
\M{D}_k = \M{D}
\end{align*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Decision variables}
\begin{equation*}
\V{X} = 
\begin{bmatrix} 
    \cJerk \\ 
    \FD
\end{bmatrix}
\end{equation*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Condensing}

\begin{equation*}
\cState = \M{S} \cstate_0     +   \M{U} \cJerk
\end{equation*}

\begin{equation*}
    \M{S} =
        \begin{bmatrix}
        \M{A} \\
        \M{A}^2 \\
        \vdots \\
        \M{A}^{N}\\
        \end{bmatrix}
    \quad
    \M{U} =
        \begin{bmatrix}
        \M{B}               & \M{0}             & \dots & \M{0} \\
        \M{A}\M{B}          & \M{B}             & \dots & \M{0} \\
        \vdots              & \vdots            & \ddots& \vdots \\
        \M{A}^{N-1}\M{B}    & \M{A}^{N-2}\M{B}  & \dots & \M{B} \\
        \end{bmatrix}
\end{equation*}

\begin{equation*}
    \ZMP = 
        \diag{N}{\M{D}} \cState = 
        \diag{N}{\M{D}} \left(\M{S} \cstate_0  +  \M{U} \cJerk \right) = 
        \M{S}_{zmp} \cstate_0 + \M{U}_{zmp} \cJerk
\end{equation*}

\begin{equation*}
    \cVel = 
        \diag{N}{\M{I}_{v}} \cState = 
        \diag{N}{\M{I}_{v}} \left(\M{S} \cstate_0  +  \M{U} \cJerk \right) = 
        \M{S}_{vel} \cstate_0 + \M{U}_{vel} \cJerk
\end{equation*}

\begin{equation*}
    \cPos = 
        \diag{N}{\M{I}_{p}} \cState = 
        \diag{N}{\M{I}_{p}} \left(\M{S} \cstate_0  +  \M{U} \cJerk \right) = 
        \M{S}_{p} \cstate_0 + \M{U}_{p} \cJerk
\end{equation*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Foot positions and displacement}
\begin{equation*}
    \fp_{k+1} = \fp_k + \fd_{l}
    \quad
    k = 1..N
    \quad
    l = 1..M
\end{equation*}

\begin{equation*}
    \FP = \M{V}_p \fp_0 + \M{V} \FD
\end{equation*}

\begin{equation*}
    \M{V}_p = 
    \begin{bmatrix}
        \M{I}\\
        \vdots\\
        \M{I}\\
    \end{bmatrix}
    \quad
    \M{V} = 
    \begin{bmatrix}
        \V{0}   &   \V{0}   & \dots     & \V{0} \\
        \V{I}   &   \V{0}   & \dots     & \V{0} \\
        \vdots  &   \vdots  & \ddots    & \vdots \\
        \V{I}   &   \V{I}   & \dots     & \V{I} \\
    \end{bmatrix}
\end{equation*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Constraints}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{ZMP position}
\begin{equation*}
    \underline{\V{b}}_k \le \M{R}_k^T \left( \zmp_k - \fp_k \right) \le \bar{\V{b}}_k\\
\end{equation*}

\begin{equation*}
    \underbar{\V{b}} 
    \le 
    \diag{k = 1..N}{\M{R}_k^T}
    \left(
        \ZMP
        -
        \FP
    \right) 
    \le
    \bar{\V{b}}
\end{equation*}


\begin{equation*}
    \ZMP - \FP 
    =
    \M{S}_{zmp} \cstate_0  +  \M{U}_{zmp} \cJerk - \M{V}_p \fp_0 - \M{V} \FD\
    =
    \M{S}_{zmp} \cstate_0 - \M{V}_p \fp_0
    +
    \M{U}_{zmp} \cJerk - \M{V} \FD
\end{equation*}

\begin{equation*}
    \underbar{\V{b}} 
    -
    \M{R}_{zmp}
    \left(
        \M{S}_{zmp} \cstate_0 - \M{V}_p \fp_0
    \right)
    \le 
    \begin{bmatrix}
        \M{R}_{zmp} \M{U}_{zmp} & - \M{R}_{zmp} \M{V} \\
    \end{bmatrix}
    \V{X}
    \le
    \bar{\V{b}}
    -
    \M{R}_{zmp}
    \left(
        \M{S}_{zmp} \cstate_0 - \M{V}_p \fp_0
    \right)
\end{equation*}

\begin{equation*}
    \underbar{\V{g}}_{zmp}  \le  \M{G}_{zmp} \V{X}  \le  \bar{\V{g}}_{zmp}
\end{equation*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Foot placement}
\begin{equation*}
\underbar{\V{d}}_l \le \M{R}_l^T \fd_l \le \bar{\V{d}_l}
\end{equation*}

\begin{equation*}
\underbar{\V{d}} \le \begin{bmatrix} \M{0} & \M{R}_{fd} \end{bmatrix} \V{X} \le \bar{\V{d}}
\end{equation*}

\begin{equation*}
\underbar{\V{g}}_{fp}  \le  \M{G}_{fp} \V{X}  \le  \bar{\V{g}}_{fp}
\end{equation*}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Objective}
\begin{equation*}
\begin{split}
    \minimize{\cJerk, \FP}  & \frac{\alpha}{2} \norm{\cVel - \cVel_{ref}}^2 + 
                              \frac{\beta}{2}  \norm{\cJerk}^2 + 
                              \frac{\gamma}{2} \norm{\ZMP - \FP}^2
\end{split}
\end{equation*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Reference velocity}
\begin{equation*}
\begin{split}
    &\norm{\cVel - \cVel_{ref}}^2 
    = 
    \norm{\M{S}_{vel} \cstate_0  +  \M{U}_{vel} \cJerk  -  \cVel_{ref}}^ 2 
    = \\
    & \cancel{\cstate_0^T \M{S}_{vel}^T  \M{S}_{vel} \cstate_0}  
    +  
    \cJerk^T \M{U}_{vel}^T \M{S}_{vel} \cstate_0  
    -  
    \cancel{\cVel_{ref}^T \M{S}_{vel} \cstate_0}\\
%
    & +  
    \cstate_0^T \M{S}_{vel}^T \M{U}_{vel} \cJerk  
    +  
    \cJerk^T \M{U}_{vel}^T \M{U}_{vel} \cJerk   
    -  
    \cVel_{ref}^T \M{U}_{vel} \cJerk\\
%
    & -  
    \cancel{\cstate_0^T \M{S}_{vel}^T \cVel_{ref}}  
    -  
    \cJerk^T \M{U}_{vel}^T \cVel_{ref}  
    +  
    \cancel{\cVel_{ref}^T \cVel_{ref}}
\end{split}
\end{equation*}

\begin{equation*}
    \frac{\alpha}{2} \cJerk^T \M{U}_{vel}^T \M{U}_{vel} \cJerk  
    +  
    \alpha 
    \left(
        \cstate_0^T \M{S}_{vel}^T \M{U}_{vel}
        -
        \cVel_{ref}^T \M{U}_{vel} 
    \right)
    \cJerk 
\end{equation*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Jerk}
\begin{equation*}
    \frac{\beta}{2}  \norm{\cJerk}^2 = \frac{\beta}{2} \cJerk^T \cJerk
\end{equation*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Displacement from the reference ZMP}
\begin{equation*}
\begin{split}
    &\norm{\ZMP - \FP}^2 = 
    \norm{\M{S}_{zmp} \cstate_0 + \M{U}_{zmp} \cJerk  -  \M{V}_p \fp_0 - \M{V} \FD} ^ 2 = \\
%
%    \cstate_0^T \M{S}_{zmp}^T  
%        + \cJerk^T \M{U}_{zmp}^T  
%            -  \fp_0^T \M{V}_p^T 
%                - \FD^T \M{V}^T
%    \M{S}_{zmp} \cstate_0 
%        + \M{U}_{zmp} \cJerk  
%            -  \M{V}_p \fp_0 
%                - \M{V} \FD
%
    &
    \cancel{\cstate_0^T \M{S}_{zmp}^T \M{S}_{zmp} \cstate_0} 
    + \cJerk^T \M{U}_{zmp}^T \M{S}_{zmp} \cstate_0
    - \cancel{\fp_0^T \M{V}_p^T \M{S}_{zmp} \cstate_0}
    - \FD^T \M{V}^T \M{S}_{zmp} \cstate_0 \\
    &
    + \cstate_0^T \M{S}_{zmp}^T \M{U}_{zmp} \cJerk 
    + \cJerk^T \M{U}_{zmp}^T \M{U}_{zmp} \cJerk
    - \fp_0^T \M{V}_p^T \M{U}_{zmp} \cJerk
    - \FD^T \M{V}^T \M{U}_{zmp} \cJerk\\
    &
    - \cancel{\cstate_0^T \M{S}_{zmp}^T \M{V}_p \fp_0}
    - \cJerk^T \M{U}_{zmp}^T \M{V}_p \fp_0
    + \cancel{\fp_0^T \M{V}_p^T \M{V}_p \fp_0}
    + \FD^T \M{V}^T \M{V}_p \fp_0\\
    &
    - \cstate_0^T \M{S}_{zmp}^T \M{V} \FD
    - \cJerk^T \M{U}_{zmp}^T \M{V} \FD
    + \fp_0^T \M{V}_p^T \M{V} \FD
    + \FD^T \M{V}^T \M{V} \FD\\
\end{split}
\end{equation*}

\begin{equation*}
\begin{split}
    &
    \frac{\gamma}{2} \cJerk^T \M{U}_{zmp}^T \M{U}_{zmp} \cJerk
    + 
    \gamma 
    \left(
        \cstate_0^T \M{S}_{zmp}^T \M{U}_{zmp}
        - 
        \fp_0^T \M{V}_p^T \M{U}_{zmp} 
    \right)
    \cJerk\\
    &
    \frac{\gamma}{2} \FD^T \M{V}^T \M{V} \FD
    + 
    \gamma 
    \left(
        \fp_0^T \M{V}_p^T \M{V}
        - 
        \cstate_0^T \M{S}_{zmp}^T \M{V}
    \right)
    \FD\\
    &
    - \gamma \cJerk^T \M{U}_{zmp}^T \M{V} \FD
\end{split}
\end{equation*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Objective in the matrix form}
\begin{equation*}
\begin{split}
    \minimize{\V{X}}    & \frac{1}{2} \V{X}^T\M{H}\V{X} + \V{q} \V{X}
\end{split}
\end{equation*}

\begin{equation*}
\M{H} = 
    \begin{bmatrix}
        \M{H}_{jerk}        &   \M{H}_{jerk,fp}\\
        \M{H}_{jerk,fp}^T   &   \M{H}_{fp}
    \end{bmatrix}
\quad
\V{q} = 
    \begin{bmatrix}
        \V{q}_{jerk}\\
        \V{q}_{fp}
    \end{bmatrix}
\end{equation*}

\begin{equation*}
\begin{split}
& \M{H}_{jerk} = 
    \alpha \M{U}_{vel}^T \M{U}_{vel} 
    + \beta \M{I}
    + \gamma \M{U}_{zmp}^T \M{U}_{zmp}\\
& \M{H}_{fp} = 
    \gamma \M{V}^T \M{V}\\
& \M{H}_{jerk,fp} = 
    - \gamma \M{U}_{zmp}^T \M{V}
\end{split}
\end{equation*}


\begin{equation*}
\begin{split}
& \V{q}_{jerk} = 
    \alpha 
    \left(
        \cstate_0^T \M{S}_{vel}^T \M{U}_{vel}
        -
        \cVel_{ref}^T \M{U}_{vel} 
    \right)
    + 
    \gamma 
    \left(
        \cstate_0^T \M{S}_{zmp}^T \M{U}_{zmp}
        - 
        \fp_0^T \M{V}_p^T \M{U}_{zmp} 
    \right)\\
& \V{q}_{fp} =
    \gamma 
    \left(
        \fp_0^T \M{V}_p^T \M{V}
        - 
        \cstate_0^T \M{S}_{zmp}^T \M{V}
    \right)
\end{split}
\end{equation*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{QP}
\begin{equation*}
\begin{split}
    \minimize{\V{X}}    & \frac{1}{2} \V{X}^T\M{H}\V{X} + \V{q} \V{X}\\
    \subjectto          & \underbar{\V{g}}_{zmp}  \le  \M{G}_{zmp} \V{X}  \le  \bar{\V{g}}_{zmp}\\
                        & \underbar{\V{g}}_{fp}  \le  \M{G}_{fp} \V{X}  \le  \bar{\V{g}}_{fp}
\end{split}
\end{equation*}
